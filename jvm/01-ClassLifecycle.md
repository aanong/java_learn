# Class Lifecycle (类加载生命周期)

## 一、类的生命周期概述

类的生命周期描述了一个类从加载到卸载的全过程。整个生命周期包括7个阶段：

1. **加载 (Loading)**
2. **验证 (Verification)**
3. **准备 (Preparation)**
4. **解析 (Resolution)**
5. **初始化 (Initialization)**
6. **使用 (Using)**
7. **卸载 (Unloading)**

其中，验证、准备、解析 3 个部分统称为 **连接 (Linking)**。

![Class Lifecycle](https://img-blog.csdnimg.cn/20210508160249275.png)

## 二、各个阶段详解

### 1. 加载 (Loading)
在加载阶段，JVM 需要完成以下三件事：
- **通过全类名获取定义此类的二进制字节流**。
- **将字节流所代表的静态存储结构转化为方法区的运行时数据结构**。
- **在内存中生成一个代表该类的 `java.lang.Class` 对象**，作为方法区这个类的各种数据的访问入口。

### 2. 验证 (Verification)
确保 Class 文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。
- **文件格式验证**：验证字节流是否符合 Class 文件格式的规范 (如魔数 `0xCAFEBABE`，版本号等)。
- **元数据验证**：对字节码描述的信息进行语义分析。
- **字节码验证**：通过数据流和控制流分析，确定程序语义是合法的、符合逻辑的。
- **符号引用验证**：确保解析动作能正确执行。

### 3. 准备 (Preparation)
为类变量（static 修饰的变量）分配内存并设置初始值。
- **内存分配**：仅包括类变量，不包括实例变量（实例变量在对象实例化时随对象一起分配在堆中）。
- **初始值设置**：通常情况下是数据类型的零值（如 0, null, false）。
    - 例：`public static int value = 123;` 准备阶段 value 值为 0。
    - 特殊情况：如果是 `final` 常量，准备阶段就会被赋值为指定的值。
    - 例：`public static final int value = 123;` 准备阶段 value 值为 123。

### 4. 解析 (Resolution)
虚拟机将常量池内的 **符号引用** 替换为 **直接引用** 的过程。
- **符号引用**：一组符号来描述所引用的目标。
- **直接引用**：直接指向目标的指针、相对偏移量或句柄。

### 5. 初始化 (Initialization)
初始化阶段是执行类构造器 `<clinit>()` 方法的过程。
- `<clinit>()` 方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块 (`static {}`) 中的语句合并产生的。
- 虚拟机会保证一个类的 `<clinit>()` 方法在多线程环境中被正确地加锁、同步。
- **触发初始化的时机**：
    1. 遇到 `new`, `getstatic`, `putstatic`, `invokestatic` 字节码指令时。
    2. 使用 `java.lang.reflect` 包的方法对类进行反射调用时。
    3. 初始化一个类时，如果其父类还没有初始化，则先初始化父类。
    4. 虚拟机启动时，用户需要指定一个要执行的主类（Main 类）。

### 6. 使用 (Using)
类被加载并初始化后，就可以被程序使用了。包括创建实例、调用方法、访问字段等。

### 7. 卸载 (Unloading)
当类不再被需要时，从方法区中移除。
- **条件非常苛刻**：
    1. 该类所有的实例都已经被回收。
    2. 加载该类的 `ClassLoader` 已经被回收。
    3. 该类对应的 `java.lang.Class` 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。
